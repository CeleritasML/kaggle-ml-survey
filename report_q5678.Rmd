---
title: "report_q5678"
author: "Jingsong, GAO"
date: "2021/12/4"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
    highlight: kate
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tidyverse'))
options(htmltools.dir.version = FALSE)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggthemes, latex2exp, glue,
               DT, plotly, extrafont)

ggplot2::theme_set(
  theme_fivethirtyeight() +
    theme(
        text = element_text(family = "Roboto Condensed"),
        title = element_text(size = 14),
        plot.subtitle = element_text(size = 12),
        plot.caption = element_text(size = 10),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        panel.grid.minor.x = element_blank()
    )
)
set.seed(511)
```

```{r pkg, message=FALSE}
col_names <- names(read_csv(
  "data/kaggle_survey_2021_responses.csv",
  n_max=0))
dat <- read_csv(
  "data/kaggle_survey_2021_responses.csv",
  col_names = col_names, skip=2)

dat <- dat %>%
  filter(Q3=="United States of America" )

job.dat <- dat %>%
    filter(Q5 %in% c("Data Analyst",
                     "Data Engineer",
                     "Data Scientist",
                     "Machine Learning Engineer",
                     "Software Engineer",
                     "Statistician",
                     "Student")) %>%
    mutate(Q25 = str_remove_all(Q25, "[$,]")) %>%
    mutate(Q25 = str_replace(Q25, ">1000000", "1000000-2000000")) %>%
    separate(Q25, into = c("salary_lb", "salary_ub"), sep = "-") %>%
    mutate(salary_lb = as.numeric(salary_lb)) %>%
    mutate(salary_ub = as.numeric(salary_ub))
```

## Q5: Key Skillsets

What is the typical skill set for these jobs? How does it affect the pay rate?

Here the key skill is defined as a skill that has been acquired more than 10% people under certain job title.

```{r q5-skill}
skill.set <- job.dat %>% 
    filter(Q5 != "Other") %>%
    select(c(Q5, starts_with("Q7_"), starts_with("Q9_"), 
             starts_with("Q12_"), starts_with("Q14_"),
             starts_with("Q16_"), starts_with("Q17_"),
             starts_with("Q18_"), starts_with("Q19_"),
             salary_lb)) %>%
    mutate(Total = "`Total`") %>%
    gather("fake_key", "skillset", 
           -c(Q5, salary_lb), na.rm = T) %>%
    filter(!skillset %in% c("None", "Other")) %>%
    rename(title = Q5) %>%
    group_by(title, skillset) %>%
    summarise(n = n(), 
              salary_mean = round(mean(salary_lb, na.rm = T)),
              salary_sd = round(sd(salary_lb, na.rm = T)),
              .groups = "drop") %>%
    group_by(title) %>%
    mutate(prop = round(n * 100 / max(n), 1)) %>%
    filter(prop >= 0.1) %>%
    select(-n) %>%
    arrange(title, desc(prop))

datatable(skill.set, filter = 'top', width = 800)
```

From the table, huge salary variances make it impossible to tell whether a skill will increase the salary or not. 

## Q6: Correlation between Industry and Job

Is there a certain correlation between industry and the need for these jobs?

```{r q6-ind}
industry.dat <- job.dat %>%
    filter(Q5 != "Student") %>%
    select(Q5, Q20, salary_lb, salary_ub) %>%
    mutate(Q20 = case_when(
        Q20 == "Academics/Education" ~ "Academics",
        Q20 == "Accounting/Finance" ~ "Finance", 
        Q20 == "Computers/Technology" ~ "Computers",
        Q20 == "Medical/Pharmaceutical" ~ "Medical",
        Q20 == "Online Service/Internet-based Services" ~ "Internet",
        TRUE ~ Q20
    )) %>%
    filter(Q20 %in% c("Academics", "Finance", "Computers",
                      "Medical", "Internet"))

p <- industry.dat %>% 
    count(Q5, Q20) %>%
    mutate(Q20 = fct_reorder(Q20, n, .fun="sum")) %>%
    rename(title=Q5, Industry=Q20, count=n) %>%
    ggplot(aes(x=title, y=count)) +
    geom_bar(stat = "identity") +
    coord_flip() +
    facet_wrap(~ Industry) +
    labs(
        title = "Users' work industry",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p)
```

A prop.table version.

```{r}
ind.dis <- industry.dat %>% 
    filter(Q5 != "Statistician") %>%
    rename(Title = Q5, Industry = Q20)
ind.dis %>%
    group_by(Industry) %>%
    count(Title) %>%
    mutate(Proportion = round(prop.table(n), 3)) %>%
    select(-n) %>%
    pivot_wider(names_from = Industry, values_from = Proportion)
```

Some hypothesis that use prop.test to examine:  

```{r}
aca.dis <- ind.dis %>% filter(Industry == "Academics")
com.dis <- ind.dis %>% filter(Industry == "Computers")
fin.dis <- ind.dis %>% filter(Industry == "Finance")
int.dis <- ind.dis %>% filter(Industry == "Internet")
med.dis <- ind.dis %>% filter(Industry == "Medical")

ds.dis <- ind.dis %>% filter(Title == "Data Scientist")
da.dis <- ind.dis %>% filter(Title == "Data Analyst")
de.dis <- ind.dis %>% filter(Title == "Data Engineer")

my.prop.test <- function(target.dis, other.dis, title) {
    target <- sum(target.dis$Title == title)
    other <- sum(other.dis$Title == title)
    t.res <- prop.test(c(target, other),
          c(nrow(target.dis), nrow(other.dis)),
          alternative = "greater",
          correct = TRUE)
    return(paste0("X-squared = ", round(t.res$statistic,1), 
                  ", p-value = ", formatC(t.res$p.value, 
                                          format = "e", digits = 2),
                  ", 95% CI = (", round(t.res$conf.int[1], 2), 
                  ", ", round(t.res$conf.int[2], 2),"), ",
                  if_else(t.res$p.value < 0.05, "H0 rejected", 
                          "can't reject H0")))
}

my.prop.test2 <- function(ind.dis, title1, title2) {
    target <- sum(ind.dis$Title == title1)
    other <- sum(ind.dis$Title == title2)
    t.res <- prop.test(c(target, other),
          c(nrow(ind.dis), nrow(ind.dis)),
          alternative = "greater",
          correct = TRUE)
    return(paste0("X-squared = ", round(t.res$statistic,1), 
                  ", p-value = ", formatC(t.res$p.value, 
                                          format = "e", digits = 2),
                  ", 95% CI = (", round(t.res$conf.int[1], 2), 
                  ", ", round(t.res$conf.int[2], 2),"), ",
                  if_else(t.res$p.value < 0.05, "H0 rejected", 
                          "can't reject H0")))
}
```

(1) $H_a$: Data Analyst is more needed in Academics Industry.

To Computers: `r my.prop.test(aca.dis, com.dis, "Data Analyst")`.  
To Finance: `r my.prop.test(aca.dis, fin.dis, "Data Analyst")`.  
To Internet: `r my.prop.test(aca.dis, int.dis, "Data Analyst")`.  
To Medical:  `r my.prop.test(aca.dis, med.dis, "Data Analyst")`.  

(2) $H_a$: Data Scientist is more needed in Medical Industry.

To Academics: `r my.prop.test(med.dis, aca.dis, "Data Scientist")`.  
To Computers: `r my.prop.test(med.dis, com.dis, "Data Scientist")`.  
To Finance: `r my.prop.test(med.dis, fin.dis, "Data Scientist")`.  
To Internet: `r my.prop.test(med.dis, int.dis, "Data Scientist")`.  

(3) $H_a$: Software Engineer is more needed in Computers Industry.

To Academics: `r my.prop.test(com.dis, aca.dis, "Software Engineer")`.  
To Finance: `r my.prop.test(com.dis, fin.dis, "Software Engineer")`.  
To Internet: `r my.prop.test(com.dis, int.dis, "Software Engineer")`.  
To Medical:`r my.prop.test(com.dis, med.dis, "Software Engineer")`.  

(4) $H_a$: Machine Learning Engineer is more needed in Internet Industry.

To Academics: `r my.prop.test(com.dis, aca.dis, "Machine Learning Engineer")`.  
To Computers: `r my.prop.test(med.dis, com.dis, "Machine Learning Engineer")`.  
To Finance: `r my.prop.test(com.dis, fin.dis, "Machine Learning Engineer")`.  
To Medical: `r my.prop.test(com.dis, med.dis, "Machine Learning Engineer")`.  

(5) $H_a$: Overall, Data Scientist is more needed than other jobs.

To Data Analyst: `r my.prop.test2(ind.dis, "Data Scientist", "Data Analyst")`.  
To Data Engineer: `r my.prop.test2(ind.dis, "Data Scientist", "Data Engineer")`.  
To Software Engineer: `r my.prop.test2(ind.dis, "Data Scientist", "Software Engineer")`.  
To ML Engineer: `r my.prop.test2(ind.dis, "Data Scientist", "Machine Learning Engineer")`.  


```{r q6-ind-sal}
p <- industry.dat %>% 
    filter(salary_lb != 1000000) %>%
    mutate(Q20 = fct_reorder(Q20, salary_lb, .fun='length')) %>%
    ggplot(aes(x=Q20, y=salary_lb)) +
    geom_boxplot() +
    coord_flip() +
    facet_wrap(~ Q5) +
    labs(
        title = "Users' salary vs industry",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p, tooltip="text")
```

## Q7: Languages and IDEs

What programming languages and IDEs do they use?

Survey questions Q7 (daily-used programming language), Q9 (IDE).

```{r q7-lan}
programming <- job.dat %>% 
    select(c(Q5, starts_with("Q7_"))) %>%
    gather("fake_key", "language", -Q5, na.rm = T) %>%
    rename(title = Q5) %>%
    select(-fake_key) %>%
    filter(!language %in% c("None", "Other")) %>%
    count(title, language, .drop = FALSE) %>% 
    complete(title, language) %>%
    replace_na(list(n = 0)) %>%
    group_by(title) %>%
    mutate(prop = prop.table(n))

p <- programming %>% 
    mutate(text = paste0("Language: ", language, "\n", 
                         "Job title: ", title, "\n", 
                         "Count: ", n, "\n",
                         "Proportion: ", round(prop, 3))) %>%
    ggplot(aes(language, title, fill=prop, text=text)) +
    geom_tile() +
    scale_fill_gradient(low="white", high="royalblue") +
    labs(
        title = "Users' favorite programming language",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_text(angle=90, hjust=1),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p, tooltip="text")
```

```{r q7-ide}
ide <- job.dat %>% 
    select(c(Q5, starts_with("Q9_"))) %>%
    gather("fake_key", "IDE", -Q5, na.rm = T) %>%
    rename(title = Q5) %>%
    select(-fake_key) %>%
    mutate(IDE = case_when(
        IDE == "Visual Studio Code (VSCode)" ~ "VSCode",
        IDE == "Jupyter (JupyterLab, Jupyter Notebooks, etc)" ~ "Jupyter Notebook",
        TRUE ~ IDE
    )) %>%
    filter(!IDE %in% c("None", "Other")) %>%
    count(title, IDE, .drop = FALSE) %>% 
    complete(title, IDE) %>%
    replace_na(list(n = 0)) %>%
    group_by(title) %>%
    mutate(prop = prop.table(n))

p <- ide %>% 
    mutate(text = paste0("IDE: ", IDE, "\n", 
                         "Job title: ", title, "\n", 
                         "Count: ", n, "\n",
                         "Proportion: ", round(prop, 3))) %>%
    ggplot(aes(IDE, title, fill=prop, text=text)) +
    geom_tile() +
    scale_fill_gradient(low="white", high="royalblue") +
    labs(
        title = "Users' favorite IDE",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_text(angle=90, hjust=1),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p, tooltip="text")
```

## Q8: Learning Sources

Where do they get and share the knowledge?

Survey questions Q39 (share and deploy), Q40 (learning resources), Q42 (Media sources).

```{r q8-learn}
learning_platform <- job.dat %>%
    select(c(Q5, starts_with("Q40_"))) %>%
    gather("fake_key", "learning", -Q5, na.rm = T) %>%
    rename(title = Q5) %>%
    select(-fake_key) %>%
    mutate(learning = case_when(
        learning == "Cloud-certification programs (direct from AWS, Azure, GCP, or similar)" ~ "Cloud-certif Programs",
        learning == "University Courses (resulting in a university degree)" ~ "University",
        TRUE ~ learning
    )) %>%
    filter(!learning %in% c("None", "Other")) %>%
    count(title, learning, .drop = FALSE) %>%
    complete(title, learning) %>%
    replace_na(list(n = 0)) %>%
    group_by(title) %>%
    mutate(prop = prop.table(n))

p <- learning_platform %>%
    mutate(text = paste0("Platform: ", learning, "\n",
                         "Job title: ", title, "\n",
                         "Count: ", n, "\n",
                         "Proportion: ", round(prop, 3))) %>%
    ggplot(aes(learning, title, fill=prop, text=text)) +
    geom_tile() +
    scale_fill_gradient(low="white", high="royalblue") +
    labs(
        title = "Users' favorite learning platforms",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_text(angle=90, hjust=1),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p, tooltip="text")
```

```{r q8-share}
share_deploy <- job.dat %>% 
    select(c(Q5, starts_with("Q39_"))) %>%
    gather("fake_key", "share", -Q5, na.rm = T) %>%
    rename(title = Q5) %>%
    select(-fake_key) %>%
    mutate(share = case_when(
        share == "I do not share my work publicly" ~ "\'PRIVATE\'",
        TRUE ~ share
    )) %>%
    filter(!share %in% c("Other")) %>%
    count(title, share, .drop = FALSE) %>% 
    complete(title, share) %>%
    replace_na(list(n = 0)) %>%
    group_by(title) %>%
    mutate(prop = prop.table(n))

p <- share_deploy %>% 
    mutate(text = paste0("Platform: ", share, "\n", 
                         "Job title: ", title, "\n",
                         "Count: ", n, "\n",
                         "Proportion: ", round(prop, 3))) %>%
    ggplot(aes(share, title, fill=prop, text=text)) +
    geom_tile() +
    scale_fill_gradient(low="white", high="royalblue") +
    labs(
        title = "Users' favorite share platforms",
        x = "",
        y = "",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_text(angle=90, hjust=1),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p, tooltip="text")
```

```{r q8-media}
media_source <- job.dat %>% 
    select(c(Q5, starts_with("Q42_"))) %>%
    gather("fake_key", "media", -Q5, na.rm = T) %>%
    rename(title = Q5) %>%
    select(-fake_key) %>%
    filter(!media %in% c("None", "Other")) %>%
    count(title, media, .drop = FALSE) %>% 
    complete(title, media) %>%
    replace_na(list(n = 0)) %>%
    group_by(title) %>%
    mutate(prop = prop.table(n)) %>%
    separate(media, into = c("media", "media_suffix"), sep = " \\(")

p <- media_source %>% 
    mutate(text = paste0("Platform: ", media, "\n", 
                         "Job title: ", title, "\n", 
                         "Count: ", n, "\n", 
                         "Proportion: ", round(prop, 3))) %>%
    ggplot(aes(media, title, fill=prop, text=text)) +
    geom_tile() +
    scale_fill_gradient(low="white", high="royalblue") +
    labs(
        title = "Users' favorite media source",
        caption = glue("Author: celeritasML
                   Source: Kaggle")) +
    theme(axis.ticks.x = element_blank(),
          axis.text.x = element_text(angle=90, hjust=1),
          axis.title = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
ggplotly(p, tooltip="text")
```




