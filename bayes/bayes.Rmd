---
title: "BayesNetwork"
author: "Jingsong, GAO"
date: "2021/10/19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(bnlearn)
library(dplyr)
library(gRain)
library(lattice)
library(Rgraphviz)
```

```{r}
file = "../data/kaggle_survey_2021_responses.csv"
headers = read.csv(file, skip = 0, header = F, nrows = 1, as.is = T, fileEncoding = "utf8")
dat = read.csv(file, skip = 2, header = F, fileEncoding = "utf8")
colnames(dat)= headers
```

Use a subset of questions and rename columns.
```{r}
dat.small = data.frame(
  age = factor(dat$Q1),
  gender = factor(dat$Q2),
  country = factor(dat$Q3),
  education = factor(dat$Q4),
  title = factor(dat$Q5),
  code.year = factor(dat$Q6),
  code.python = factor(dat$Q7_Part_1 != ""),
  code.r = factor(dat$Q7_Part_2 != ""),
  code.sql = factor(dat$Q7_Part_3 != ""),
  code.c = factor(dat$Q7_Part_4 != ""),
  code.cpp = factor(dat$Q7_Part_5 != ""),
  code.java = factor(dat$Q7_Part_6 != ""),
  code.javascript = factor(dat$Q7_Part_7 != ""),
  code.julia = factor(dat$Q7_Part_8 != ""),
  code.swift = factor(dat$Q7_Part_9 != ""),
  code.bash = factor(dat$Q7_Part_10 != ""),
  code.matlab = factor(dat$Q7_Part_11 != ""))
str(dat.small)
```

Build a network based on the subset.
```{r}
net.small = empty.graph(names(dat.small))
modelstring(net.small) = "[age][gender][country][education|age:gender:country][code.year][code.python][code.r][code.sql][code.c][code.cpp][code.java][code.javascript][code.julia][code.swift][code.bash][code.matlab][title|education:code.year:code.python:code.r:code.sql:code.c:code.cpp:code.java:code.javascript:code.julia:code.swift:code.bash:code.matlab]"
net.small
```

Visualize the network.
```{r}
graphviz.plot(net.small)
```

Fit the parameter in the network using the subset.
```{r}
fit = bn.fit(net.small, dat.small)
```

Play with the fitted model. 

"What the marginal distribution of *education* and *job title* for a 18-21 years old man which lives in China and can code in Python?"
```{r}
#graphviz.chart(fit, type = "barprob")
junction = compile(as.grain(fit))
j1 = setEvidence(junction, nodes = c("age", "gender", "country", "code.python"), states = c("18-21", "Man", "China", "TRUE"))
querygrain(j1, nodes = c("education", "title"), type = "marginal")
```

"What if he can't code in Python?"
```{r}
j2 = setEvidence(junction, nodes = c("age", "gender", "country", "code.python"), states = c("18-21", "Man", "China", "FALSE"))
querygrain(j2, nodes = c("education", "title"), type = "marginal")
```


