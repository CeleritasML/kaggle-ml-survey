---
title: "report_q12345"
author: "Ercong Luo"
date: "11/29/2021"
output: html_document
---

Questionnaire Answer Choices: 
https://github.com/CeleritasML/kaggle-ml-survey/blob/main/data/supplementary_data/kaggle_survey_2021_answer_choices.pdf


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggthemes, latex2exp, glue,
               ggmosaic)

set.seed(511)
```


```{r data cleaning}

col_names <- names(read_csv(
  "data/kaggle_survey_2021_responses.csv",
  n_max=0))
dat <- read_csv(
  "data/kaggle_survey_2021_responses.csv",
  col_names = col_names, skip=2)

dat <- dat %>%
  filter(Q3=="United States of America" )
```
## Q1: Job Titles Distributions

What percentage of the survey respondents are working under these job titles? 

```{r}
jtitle <- sort(table(dat$Q5), decreasing = T) %>% 
    as.data.frame() %>%
    as.tibble()
jtitle <- rename(jtitle, `Job Title` = Var1)

ggplot(jtitle, aes(x="", y=Freq, fill=`Job Title`)) +
    geom_bar(stat="identity", width=1, color="white") +
    coord_polar("y", start=0) + 
    theme_void() 
```

## Q2: Salaries

What are the statistics on salaries for these job titles?

The US minimum wage is 7.25 per hour, multiply that for a total $260$ typical number of workdays a year:

$$7.25 \frac{\$}{\text{hour}} \cdot 8 \frac{\text{hours}}{\text{day}} \cdot 260\frac{\text{days}}{\text{year}} = 15080.$$

The new categories* for salaries will be:
- poverty: below the federal minimum wage
- low: 15,000 to 49,999
- medium: 50,000 to 99,999
- high: 100,000 to 199,999
- very high: 200,000 to 499,999
- highest: >= 500,000

*loosely based on US federal income tax brackets. 


```{r}
# To change salary categories into FACTOR dtype with descending labels
poverty   = c("$0-999", "1,000-1,999" , "2,000-2,999", "3,000-3,999", "4,000-4,999", "5,000-7,499", "7,500-9,999",
             "10,000-14,999") 
low       = c("15,000-19,999", "20,000-24,999", "25,000-29,999", "30,000-39,999", "40,000-49,999")
medium    = c("50,000-59,999", "60,000-69,999", "70,000-79,999", "80,000-89,999", "90,000-99,999") 
high      = c("100,000-124,999", "125,000-149,999", "150,000-199,999")
very_high = c("200,000-249,999", "250,000-299,999", "300,000-499,999")
highest   = c("$500,000-999,999", ">$1,000,000")

dat$Q25[dat$Q25 %in% poverty] <- "poverty"
dat$Q25[dat$Q25 %in% low] <- "low"
dat$Q25[dat$Q25 %in% medium] <- "medium"
dat$Q25[dat$Q25 %in% high] <- "high"
dat$Q25[dat$Q25 %in% very_high] <- "very high"
dat$Q25[dat$Q25 %in% highest] <- "highest"
dat$Q25 = factor(dat$Q25, levels = c("poverty", "low", "medium", "high", "very high", "highest"), ordered = T)

data_side <- c("Data Scientist", "Data Analyst", "Business Analyst", "Data Engineer", "Statistician", "DBA/Database Engineer")
swe_side <- c("Software Engineer", "Machine Learning Engineer", "Program/Project Manager", "Product Manager") 
academia <- c("Student", "Other", "Research Scientist") 

dat[dat$Q5 %in% data_side & !is.na(dat$Q5) & !is.na(dat$Q25), ] %>%
  ggplot( aes(x=Q5, y=Q25, color = Q5)) +
    geom_count() + 
    ggtitle("Two-Way Salary Visualizations: Data-Oriented Jobs") +
    xlab("") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))


dat[dat$Q5 %in% swe_side & !is.na(dat$Q5) & !is.na(dat$Q25), ] %>%
  ggplot( aes(x=Q5, y=Q25, color = Q5)) +
    geom_count() + 
    ggtitle("Two-Way Salary Visualizations: Engineering-Oriented Jobs") +
    xlab("") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

dat[dat$Q5 %in% academia & !is.na(dat$Q5) & !is.na(dat$Q25), ] %>%
  ggplot( aes(x=Q5, y=Q25, color = Q5)) +
    geom_count() + 
    ggtitle("Two-Way Salary Visualizations: Academic Jobs and Others") +
    xlab("") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

A chi-squared test of independence can be used to test for the statistical significance in the difference in categorical frequencies in each salary category for each job title. On the one hand, the test is done on data-oriented data science roles, see below: 

```{r}
expectedcounts <- function(A){
  r <- rowSums(A)
  c <- colSums(A)
  N = sum(A)
  expected <- outer(r,c)/N
  return(expected)
}


q2_table.1 = table(dat$Q25[dat$Q5 %in% data_side], dat$Q5[dat$Q5 %in% data_side])
q2_table.df = q2_table.1 %>% as.data.frame() %>% as.tibble()
q2_expectedcounts <- expectedcounts(q2_table.1) %>% as.data.frame() %>% as.tibble()

ggplot(q2_table.df, aes(x = Var2, y = Freq, fill = Var1)) +
    geom_col(position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

(chisq.test(q2_table.1, simulate.p.value = T, B = 10000))
```

Qualitatively, it can be seen that each job title has a seemingly different categorical distribution over the salary brackets. The chi-squared test using simulated p-values reveals that this difference is statistically significant as well with a p-value of $0.0004998$. At an alpha-level of 0.05, the null hypothesis that the frequency of counts over salary brackets is not independent of the job title. 

Because the original salary data is categorical instead of a numerical estimation, a two-sample t-test to test the difference of mean salary is not possible. But the visualization above reveals that for data scientists and data engineers, there are more people in medium and high salary brackets than low salary brackets; the opposite is true for business analyst and data analyst. The visualization alone is able to reveal that "analyst" is considered a more junior role compared to an "engineer" or a "data scientist". There are just too few DBA/Database engineers and statisticians represented in the dataset for a conclusion to be drawn for these categories.

It is also worth noting that most of the highest earning ($>\$500,000$) people in the dataset are data scientists. 

Below, the analysis focuses on the job titles that have more software and product focus, such as machine learning engineer (MLE), software engineer (SWE), and product manager (PM). 

```{r}
q2_table.2 = table(dat$Q25[dat$Q5 %in% swe_side], dat$Q5[dat$Q5 %in% swe_side])
q2_table.df2 = q2_table.2 %>% as.data.frame() %>% as.tibble()
q2_expectedcounts2 <- expectedcounts(q2_table.2) %>% as.data.frame() %>% as.tibble()

ggplot(q2_table.df2, aes(x = Var2, y = Freq, fill = Var1)) +
    geom_col(position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

(chisq.test(q2_table.2, simulate.p.value = T, B = 10000))
```

As can be seen above, more MLEs command the highest category of salary than any other job title. The average MLE will earn at or above the medium salary bracket. As for PMs, very few of them ear a low salary; in fact, most of them are in the medium to very high brackets of income. The salary distribution for project managers is similar to that of PMs, except there are significantly more professionals in the low income bracket. Last but not least, most SWEs command a medium to high salary, with still a significant number of professional earning outside this range on both the high end and the lower end. 

## Q3: Requried Education Levels

What levels of education are required for these job titles?

### Aggregate Level

```{r}
edu <- sort(table(dat$Q4), decreasing = T) %>% 
    as.data.frame() %>%
    as.tibble()
edu <- rename(edu, `Degree` = Var1)

ggplot(edu, aes(x="", y=Freq, fill=`Degree`)) +
    geom_bar(stat="identity", width=1, color="white") +
    coord_polar("y", start=0) + 
    theme_void() 
```


### Break down by Job Title

```{r}

```


## Q4: Gender Gap in Income

Is there a significant income gap between genders for these jobs?

### What about at an aggregate level? 
```{r}

```


### By groups aggregated depending on years of experience? 

### By industry? 

### By Geographical Location? 
